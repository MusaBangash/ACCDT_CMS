{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2>Student Management</h2>
            <p class="text-muted">View and manage all registered students</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('students.register_student') }}" class="btn btn-primary">
                <i class="fas fa-user-plus"></i> Register Student
            </a>
            <a href="{{ url_for('students.create_student') }}" class="btn btn-success">
                <i class="fas fa-plus"></i> Add Student (Admin)
            </a>
            <a href="{{ url_for('students.print_student_list') }}" class="btn btn-info" target="_blank">
                <i class="fas fa-print"></i> Print List
            </a>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body">
                    <h6 class="card-title text-muted">Total Students</h6>
                    <h2 class="card-text">{{ total }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body">
                    <h6 class="card-title text-muted">Day Scholars</h6>
                    <h2 class="card-text" id="dayScholars">0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body">
                    <h6 class="card-title text-muted">Hostel Students</h6>
                    <h2 class="card-text" id="hostelStudents">0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body">
                    <h6 class="card-title text-muted">Active Status</h6>
                    <h2 class="card-text" id="activeStudents">0</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-6">
                    <input type="text" class="form-control" name="search" placeholder="Search by name, CNIC or phone..." 
                           value="{{ search or '' }}">
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search"></i> Search
                    </button>
                </div>
                <div class="col-md-3">
                    <a href="{{ url_for('students.list_students') }}" class="btn btn-secondary w-100">
                        <i class="fas fa-redo"></i> Reset
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Students Table -->
    <div class="card">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>#</th>
                        <th>Name</th>
                        <th>Gender</th>
                        <th>Phone</th>
                        <th>CNIC</th>
                        <th>Admission Type</th>
                        <th>Courses</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if students %}
                        {% for student in students %}
                        <tr>
                            <td>{{ student.id }}</td>
                            <td>
                                <strong>{{ student.full_name }}</strong>
                                <br>
                                <small class="text-muted">Reg: {{ student.registration_number or 'N/A' }}</small>
                                <br>
                                <small class="text-muted">{{ student.city }}</small>
                            </td>
                            <td>
                                {% if student.gender == 'M' %}
                                    <span class="badge bg-primary">Male</span>
                                {% elif student.gender == 'F' %}
                                    <span class="badge bg-danger">Female</span>
                                {% else %}
                                    <span class="badge bg-secondary">Other</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="tel:{{ student.phone }}">{{ student.phone }}</a>
                            </td>
                            <td><code>{{ student.cnic }}</code></td>
                            <td>
                                {% if student.admission_type == 'day_scholar' %}
                                    <span class="badge bg-info">Day Scholar</span>
                                {% else %}
                                    <span class="badge bg-warning">Hostel</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-secondary">{{ student.enrollments.count() }} courses</span>
                            </td>
                            <td>
                                {% if student.status == 'active' %}
                                    <span class="badge bg-success">Active</span>
                                {% elif student.status == 'inactive' %}
                                    <span class="badge bg-danger">Inactive</span>
                                {% elif student.status == 'graduated' %}
                                    <span class="badge bg-info">Graduated</span>
                                {% elif student.status == 'leave' %}
                                    <span class="badge bg-warning">On Leave</span>
                                {% else %}
                                    <span class="badge bg-secondary">{{ student.status|title }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-primary dropdown-toggle" type="button" 
                                            id="dropdownActions{{ student.id }}" data-bs-toggle="dropdown" 
                                            aria-expanded="false" title="Actions">
                                        <i class="fas fa-cog"></i> Actions
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="dropdownActions{{ student.id }}">
                                        <li>
                                            <a class="dropdown-item" href="{{ url_for('students.view_student', student_id=student.id) }}">
                                                <i class="fas fa-eye"></i> View Profile
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" href="{{ url_for('students.edit_student', student_id=student.id) }}">
                                                <i class="fas fa-edit"></i> Edit Information
                                            </a>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                        {% if student.status != 'active' %}
                                        <li>
                                            <form method="POST" action="{{ url_for('students.update_student_status', student_id=student.id) }}" style="display: inline;">
                                                <input type="hidden" name="status" value="active">
                                                <button type="submit" class="dropdown-item text-success">
                                                    <i class="fas fa-check-circle"></i> Mark Active
                                                </button>
                                            </form>
                                        </li>
                                        {% endif %}
                                        {% if student.status != 'inactive' %}
                                        <li>
                                            <form method="POST" action="{{ url_for('students.update_student_status', student_id=student.id) }}" style="display: inline;">
                                                <input type="hidden" name="status" value="inactive">
                                                <button type="submit" class="dropdown-item text-danger">
                                                    <i class="fas fa-ban"></i> Mark Inactive
                                                </button>
                                            </form>
                                        </li>
                                        {% endif %}
                                        {% if student.status != 'graduated' %}
                                        <li>
                                            <form method="POST" action="{{ url_for('students.update_student_status', student_id=student.id) }}" style="display: inline;">
                                                <input type="hidden" name="status" value="graduated">
                                                <button type="submit" class="dropdown-item text-info">
                                                    <i class="fas fa-graduation-cap"></i> Mark Graduated
                                                </button>
                                            </form>
                                        </li>
                                        {% endif %}
                                        {% if student.status != 'leave' %}
                                        <li>
                                            <form method="POST" action="{{ url_for('students.update_student_status', student_id=student.id) }}" style="display: inline;">
                                                <input type="hidden" name="status" value="leave">
                                                <button type="submit" class="dropdown-item text-warning">
                                                    <i class="fas fa-calendar-times"></i> Mark On Leave
                                                </button>
                                            </form>
                                        </li>
                                        {% endif %}
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <button type="button" class="dropdown-item text-danger" 
                                                    data-student-id="{{ student.id }}" 
                                                    data-student-name="{{ student.full_name }}"
                                                    onclick="deleteStudent(this)">
                                                <i class="fas fa-trash"></i> Delete Student
                                            </button>
                                        </li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="9" class="text-center py-4">
                                <p class="text-muted">No students found</p>
                                {% if not search %}
                                    <a href="{{ url_for('students.register_student') }}" class="btn btn-primary btn-sm">
                                        Register First Student
                                    </a>
                                {% endif %}
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    {% if pages > 1 %}
    <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center">
            {% if page > 1 %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('students.list_students', page=1, search=search) }}">First</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('students.list_students', page=page-1, search=search) }}">Previous</a>
                </li>
            {% endif %}

            {% if pages <= 5 %}
                {% for p in range(1, pages+1) %}
                    {% if p == page %}
                        <li class="page-item active">
                            <span class="page-link">{{ p }}</span>
                        </li>
                    {% else %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('students.list_students', page=p, search=search) }}">{{ p }}</a>
                        </li>
                    {% endif %}
                {% endfor %}
            {% else %}
                {% for p in range(1, pages+1) %}
                    {% if p == 1 or p == pages or (p >= page-1 and p <= page+1) %}
                        {% if p == page %}
                            <li class="page-item active">
                                <span class="page-link">{{ p }}</span>
                            </li>
                        {% else %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('students.list_students', page=p, search=search) }}">{{ p }}</a>
                            </li>
                        {% endif %}
                    {% elif p == 2 and page > 3 %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    {% elif p == pages-1 and page < pages-2 %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    {% endif %}
                {% endfor %}
            {% endif %}

            {% if page < pages %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('students.list_students', page=page+1, search=search) }}">Next</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('students.list_students', page=pages, search=search) }}">Last</a>
                </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

<!-- Delete Form -->
<form id="deleteForm" method="POST" style="display: none;">
    <input type="hidden" id="deleteUrl">
</form>

<script>
function deleteStudent(button) {
    const id = button.getAttribute('data-student-id');
    const name = button.getAttribute('data-student-name');
    
    if (confirm(`Are you sure you want to delete student: ${name}?`)) {
        const form = document.getElementById('deleteForm');
        form.setAttribute('action', `/students/${id}/delete`);
        form.submit();
    }
}

// Calculate stats
document.addEventListener('DOMContentLoaded', function() {
    let dayScholarsCount = 0;
    let hostelCount = 0;
    let activeCount = 0;
    
    // Count from table rows
    const rows = document.querySelectorAll('table tbody tr');
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length > 5) {
            const admissionType = cells[5].textContent.trim();
            const status = cells[7].textContent.trim();
            
            if (admissionType.includes('Day Scholar')) dayScholarsCount++;
            if (admissionType.includes('Hostel')) hostelCount++;
            if (status.includes('Active')) activeCount++;
        }
    });
    
    document.getElementById('dayScholars').textContent = dayScholarsCount;
    document.getElementById('hostelStudents').textContent = hostelCount;
    document.getElementById('activeStudents').textContent = activeCount;
});
</script>
{% endblock %}
